<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">

	<!-- the following line is to support MathJax in older browsers -->
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
	</script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
				rel="stylesheet"
				integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
				crossorigin="anonymous">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    rel="stylesheet">

	<style>
		h1 {
			color: #990000;
		}

		h2 {
			color: #990000;
		}
	</style>
  <title>Periscope Trending Report</title>
</head>

<body data-observation="{{ source.obsid }}" data-source-id="{{ source.id }}" root-dir="../../../..">

  <div class="container-md">

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand me-auto" href="../../../..">Periscope Drift</a>
      <div class="navbar-nav">

        <a class="nav-item nav-link" href="#previous"><i class="bi bi-arrow-left"></i> prev</a>
        <a class="nav-item nav-link" href="#next">next <i class="bi bi-arrow-right"></i> </a>
      </div>
    </nav>

    <h2> OBSID {{ source.obsid }}, source {{ source.id }} </h2>

    <div class="container">
      <div class="row">
        <div class="col-3">
          <div>
            {{source_figure}}
          </div>
        </div>
        <div class="col-9">
          <div class="ratio">
            {{scatter_plot}}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <!-- <span class="align-baseline"> -->
          <div class="d-flex align-items-center">
            <table class="table table-sm">
              <tr>
                <th scope="row"> OBSID </th> <td>{{ source.obsid }} </td>
              </tr>
              <tr>
                <th scope="row"> Date </th> <td>{{ ocat.ocat.start_date }} </td>
              </tr>
              <tr>
                <th scope="row"> ID </th> <td>{{ source.id }} </td>
              </tr>
              <tr>
                <th scope="row"> off-axis angle (arcmin) </th> <td>{{ '{:.2f}'.format(source.theta) }} </td>
              </tr>
              <tr>
                <th scope="row"> yag (arcsec) </th> <td>{{ '{:.2f}'.format(source.y_angle) }} </td>
              </tr>
              <tr>
                <th scope="row"> zag (arcsec) </th> <td>{{ '{:.2f}'.format(source.z_angle) }} </td>
              </tr>
            </table>
          </div>
          <!-- </span> -->
        </div>
        <div class="col">
          <!-- <span class="align-baseline"> -->
          <div class="d-flex align-items-center">
            <table class="table table-sm">
              <tr>
                <th scope="row"> N </th> <td>{{ source.net_counts }} </td>
              </tr>
              <tr>
                <th scope="row"> SNR </th> <td>{{ '{:.1f}'.format(source.snr) }} </td>
              </tr>
              <tr>
                <th scope="row"> pileup </th> <td>{{ '{:.2f}'.format(source.max_pileup) }} </td>
              </tr>
              <tr>
                <th scope="row"> pileup size </th> <td>{{ source.pileup_size }} </td>
              </tr>
              <tr>
                <th scope="row"> duration </th> <td>{{ '{:.0f}'.format(source.obs_duration) }} </td>
              </tr>
            </table>
          </div>
          <!-- </span> -->
        </div>
        <div class="col">
          <table class="table table-sm">
            <tr>
              <th scope="row">  </th>
              <th scope="row">  </th>
              <th> yag </th>
              <th> zag </th>
            </tr>
            <tr>
              <th scope="row" colspan="2"> slope </th>
              <td> {{ "{:.1f}".format(metrics.yag_slope) }} &pm; {{ "{:.1f}".format(metrics.yag_slope_err) }}</td>
              <td> {{ "{:.1f}".format(metrics.zag_slope) }} &pm; {{ "{:.1f}".format(metrics.zag_slope_err) }}</td>
            </tr>
            <tr>
              <th scope="row" colspan="2"> chi2 (ndf) </th>
              <td> {{ "{:.1f}".format(metrics.yag_null_chi2) }} (n={{ "{:.0f}".format(metrics.yag_ndf) }})</td>
              <td> {{ "{:.1f}".format(metrics.zag_null_chi2) }} (n={{ "{:.0f}".format(metrics.zag_ndf) }})</td>
            </tr>
            <tr>
              <th scope="row" colspan="2"> p-value </th>
              <td> {{ "{:.2}".format(metrics.yag_null_p_value_corr) }} </td>
              <td> {{ "{:.2}".format(metrics.zag_null_p_value_corr) }} </td>
            </tr>
            <tr>
              <th scope="row" colspan="2"> expected drift </th>
              <td> {{ "{:.1f}".format(metrics.drift_expected_yag) }}</td>
              <td> {{ "{:.1f}".format(metrics.drift_expected_zag) }}</td>
            </tr>
            <tr>
              <th scope="row" colspan="2"> drift residual </th>
              <td> {{ "{:.1f}".format(metrics.drift_residual_yag) }}</td>
              <td> {{ "{:.1f}".format(metrics.drift_residual_zag) }}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <div class="accordion" id="accordionExclude">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingExclude">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExclude" aria-expanded="true" aria-controls="collapseExclude">
            Exclude this source
          </button>
        </h2>
        <div id="collapseExclude" class="accordion-collapse collapse" aria-labelledby="headingExclude" data-bs-parent="#accordionExclude">
          <div class="accordion-body">
            <p> Login as aca and execute the following command(s). If this region should be excluded for all OBSIDs, remove the --obsid flag. Feel free to modify the comment. </p>
            <p> to exclude from astromon: </p>
            <p> <div id="astromon_command"> <pre>
              astromon-excluded-region add --obsid {{ source.obsid }} --ra {{ source.ra }} --dec {{ source.dec }} --radius 10 --comment "Excluded after inspection";
            </pre></div> </p>
            <p> to exclude from periscope drift: </p>
            <p> <div id="periscope_drift_command"> <pre>
              ska_trend_periscope_drift_regions add --obsid {{ source.obsid }} --ra {{ source.ra }} --dec {{ source.dec }} --radius 10 --comment "Excluded after inspection";
            </pre></div> </p>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion" id="accordionExample">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            OCAT Information
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <h3> {{ ocat.abstract.proposal_title }}</h3>
            <p> {{ ocat.abstract.abstract }}</p>
          </div>
        </div>
      </div>
    </div>

      
    <h2> Telemetry </h2>
    <div class="ratio" style="--bs-aspect-ratio: 40%;">
      {{telemetry_figure}}
    </div>

    <h2> Principal Component </h2>
    <div class="ratio" style="--bs-aspect-ratio: 40%;">
      {{pc1_figure}}
    </div>

    <h2> Plots Vs Gradients </h2>
    <div class="ratio" style="--bs-aspect-ratio: 40%;">
      {{scatter_vs_gradients}}
    </div>

    <h2> Other Plots </h2>

    <h4>
      A comparison of the yag/zag distribution between the bins with the highes/lowest values.
    </h4>
    <div class="ratio" style="--bs-aspect-ratio: 40%;">
      {{extreme_bin_histograms_figure}}
    </div>

    <h4> 3d-plot of Residuals Vs Telemetry </h4>
    <div class="ratio" style="--bs-aspect-ratio: 40%;">
      {{plot_3d_figures}}
    </div>

  </div>


  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous">
  </script>

  <script>
    const element = document.getElementById('astromon_command');
    element.addEventListener('click', () => {
      const htmlContent = element.childNodes[1].innerHTML
      navigator.clipboard.writeText(htmlContent);
    });
  </script>

  <script>
    const pd_element = document.getElementById('periscope_drift_command');
    pd_element.addEventListener('click', () => {
      const htmlContent = pd_element.childNodes[1].innerHTML
      navigator.clipboard.writeText(htmlContent);
    });
  </script>

</body>

<script>

  async function fetchObservations() {
    // this is the key used in the URL parameters (?observations=...)
    const urlKey = 'observations';
    // this is the key used in session storage. Could consider making it the same as urlKey
    // or a more unique value. Users never see this.
    const storageKey = 'observations';
    // the top directory. Could consider setting this elsewhere
    const root_dir = document.body.getAttribute('root-dir');

    const urlParams = new URLSearchParams(window.location.search);
    const obs_list = urlParams.has(urlKey)? urlParams.get(urlKey): "all";
    const url = `${root_dir}/sources/${obs_list}.json`
    console.log(`Will fetch ${urlKey} list from url params: ${url}`);

    // this checks if the file exists. If it doesn't, return an empty list
    const response = await fetch(url, { method: 'HEAD' });
    if ( !response.ok ) {
      console.log(`Failed fetching ${url}. Status: ${response.status}`);
      return [[], -1];
    }

    // this checks if the file changed by comparing a stored ETag value with the current one
    const storedETag = sessionStorage.getItem(`${storageKey}_etag`);
    const currentETag = response.headers.get('etag');
    const outdated = (storedETag !== currentETag);

    // fetch from session storage if available and not outdated
    // else fetch from server and update session storage
    // note that session storage stays until the tab is closed
    var entries = null;
    const json_str = sessionStorage.getItem(storageKey);
    if (json_str && !outdated) {
      console.log(`found ${storageKey} in session storage`);
      entries = JSON.parse(json_str);
    }
    else {
      if ( !json_str ) {
        console.log(`no ${storageKey} in session storage`);
      }
      else if (outdated) {
        console.log(`ETag has changed, fetching new ${storageKey}`);
      }
      sessionStorage.setItem(`${storageKey}_etag`, currentETag);
      // Fetch the JSON file containing the URLs
      console.log(`fetching ${storageKey} from: ${url}`);
      const response = await fetch(url); // Replace with the actual URL if different
      entries = await response.json();
      sessionStorage.setItem(storageKey, JSON.stringify(entries));
    }

    // Get this document's observation from the body tag
    // and find its index in the list. If it is not found, index will be -1
    const currentEntry = document.body.getAttribute('data-observation');
    const currentSourceId = document.body.getAttribute('data-source-id');
    const currentIndex = entries.findIndex(
      ([obs, src_id, url]) => (
        obs.toString() === currentEntry.toString()
        && src_id.toString() === currentSourceId.toString()
      )
    );

    // Update button states
    // (next/previous buttons are enabled/disabled depending on the position in the list)
    _disableButtons_(entries, currentIndex)

    console.log("entries", entries);
    console.log("current entry:", currentEntry);
    console.log("current source id:", currentSourceId);
    console.log("current index:", currentIndex);

    return [entries, currentIndex];
  }

  function goToObservation(targetURL) {
    const urlKey = 'observations';
    // the top directory. Could consider setting this elsewhere
    const root_dir = document.body.getAttribute('root-dir');

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has(urlKey)) {
      const obs_list = urlParams.get(urlKey);
      targetURL = `${targetURL}?${urlKey}=${obs_list}`;
    }
    window.location.href = `${root_dir}/${targetURL}`;
  }

  async function previous() {
    const [entries, currentIndex] = await fetchObservations();
    targetIndex = currentIndex - 1;

    // Check if the current index is within bounds
    if (currentIndex < 0 || currentIndex > entries.length - 1) {
      alert("This entry is not in the list. Cannot navigate to previous.");
    }
    // Check if the target index is within bounds
    else if (targetIndex < 0) {
      alert('No more entries in this direction.');
    }
    else {
      goToObservation(entries[targetIndex][2]);
    }
  }

  async function next() {
    const [entries, currentIndex] = await fetchObservations();
    targetIndex = currentIndex + 1;

    // Check if the current index is within bounds
    if (currentIndex < 0 || currentIndex > entries.length - 1) {
      alert("This entry is not in the list. Cannot navigate to next.");
    }
    // Check if the target index is within bounds
    else if (targetIndex > entries.length - 1) {
      alert("No more entries in this direction.");
    }
    else {
      goToObservation(entries[targetIndex][2]);
    }
  }

  async function disableButtons() {
    const [entries, currentIndex] = await fetchObservations();
    _disableButtons_(entries, currentIndex);
  }
  
  function _disableButtons_(entries, currentIndex) {
    // Disable the "next"("previous") button if at the end(start) of the list
    if (currentIndex <= 0) {
      document.querySelector('a[href="#previous"]').classList.add('disabled');
    }
    else {
      document.querySelector('a[href="#previous"]').classList.remove('disabled');
    }
    if (currentIndex >= entries.length - 1 || currentIndex === -1) {
      document.querySelector('a[href="#next"]').classList.add('disabled');
    }
    else {
      document.querySelector('a[href="#next"]').classList.remove('disabled');
    }

  }
</script>

<script>
// Attach event listeners to the navigation links
document.querySelector('a[href="#next"]').addEventListener('click', (e) => {
    e.preventDefault();
    next();
});

document.querySelector('a[href="#previous"]').addEventListener('click', (e) => {
    e.preventDefault();
    previous();
});
</script>

<script>
  disableButtons();
</script>

</html>


      
